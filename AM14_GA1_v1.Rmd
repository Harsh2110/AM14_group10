---
title: "AM14_GA1"
author: "Group 10"
date: "1/10/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Load libraries 

```{r, Load libraries}
library(ggplot2)  
library(dplyr)
library(tidyverse)
library(readxl)
library(lubridate)
library(skimr)
library(moments)
```

## Question 1

Load the monthly stock data. We will also load the daily stock data, which we'll need later in the assignment.

```{r, Load the data, warning=FALSE}
# Read in the monthly data using the 'read_excel' function: 
monthly_data <- read_excel("PS1_Monthly.xlsx") %>%
  # Perform an initial cleaning of the names in the dataset.
  janitor::clean_names() %>%  
  # Mutate and transform dates stored in character/numeric vectors to Date objects
  mutate(date = ymd(date))

# Skim the data - this allows us to view specific summary statistics
skimr::skim(monthly_data)
```


The "PS1_Monthly" data contains information related to the stocks for the following 
unique companies. 

```{r}
# Output all the unique company names
print(unique(monthly_data$comnam))
```





## Question 2

Yuting: Not sure

Now, returns bla bla bla 

Also - upon inspection, the dates are not in the right format and need to be transformed. 

```{r, Question 2}
question2 <- c('MSFT', 'GE')

monthly_q2 <- monthly_data %>%
  filter(ticker %in% question2) %>%
  group_by(ticker) %>% 
  mutate(ret1 = ret+1,
         retx1 = retx +1,
         sprtrn1 = sprtrn +1) %>% 
  mutate(inv_ret = cumprod(ret1),
         inv_retx = cumprod(retx1),
         inv_sprtrn = cumprod(sprtrn1)) %>% 
  select(-ret1,-retx1,-sprtrn1)

monthly_q2 %>% filter(ticker == "MSFT") %>% 
  ggplot() +
  geom_line(aes(x = date, y=inv_ret, color="With dividend"), alpha = 0.5, size = 1)+
  geom_line(aes(x = date, y=inv_retx, color="Without dividend"),alpha = 0.5, size = 1)+
  geom_line(aes(x = date, y=inv_sprtrn, color="S&P 500"),alpha = 0.5, size = 1)+
  theme_minimal()+
  labs(
    title="Investment with versus without dividends for MSFT",
    y="Investment return",
    x="Date"
  )+
  scale_color_manual(name = "Y series", values = c("Without dividend" = "blue", "With dividend" = "red","S&P 500" = "green"))

monthly_q2 %>% filter(ticker == "GE") %>% 
  ggplot() +
  geom_line(aes(x = date, y=inv_ret, color="With dividend"), alpha = 0.5, size = 1)+
  geom_line(aes(x = date, y=inv_retx, color="Without dividend"),alpha = 0.5, size = 1)+
  geom_line(aes(x = date, y=inv_sprtrn, color="S&P 500"),alpha = 0.5, size = 1)+
  theme_minimal()+
  labs(
    title="Investment with versus without dividends for GE",
    y="Investment return",
    x="Date"
  )+
  scale_color_manual(name = "Y series", values = c("Without dividend" = "blue", "With dividend" = "red","S&P 500" = "green"))

```




## Question 3

Here, we generate a new variable that contains log returns (LRET) - we calculate 
sample statistics for these log returns and then plot the normal returns against 
the log returns for "MSFT". 

```{r}
monthly_log <- monthly_data %>% 
  # Filter out entries where returns < 0 - you cannot take a log of a negative
  filter(ret > 0) %>% 
  # Create a log return column 'lret' which takes the log of the return
  mutate(lret = log(ret)) 

# Create a new dataframe for the summary statistics we calculate
sum_table_monthly <- monthly_log %>% 
  # Group by the 'ticker' so we can calculate statistics for each one
  group_by(ticker) %>% 
  # Use the summarise function to calculate different sample statistics
  summarise(ret_mean = mean(ret),
            logret_mean = mean(lret, na.rm = TRUE),
            ret_var = var(ret),
            logret_var = var(lret, na.rm = TRUE),
            ret_skew = skewness(ret),
            logret_skew = skewness(lret, na.rm = TRUE),
            ret_kur = kurtosis(ret),
            logret_kur = kurtosis(lret, na.rm = TRUE))

# Output the new calculated sample statistics 
sum_table_monthly

monthly_log %>% 
  # Filter out "MSFT" from our 'monthly log' dataframe so that we can plot
  filter(ticker == "MSFT") %>%
  # Call ggplot
  ggplot() +
  # Create line plots for both log returns and normal returns - differentiated by colour
  geom_line(aes(x= date, y=ret, color="ret"), alpha = 0.5, size = 1)+
  geom_line(aes(x= date, y=lret, color="lret"), alpha = 0.5, size = 1)+
  # Set the figure theme
  theme_minimal()+
  # Apply labels to the plot
  labs(title="Ordinary Return v.s. Log Return for MSFT",
    y="Return",
    x="Date")+
  # Assign the appropraite colours to the plot and its legend
  scale_color_manual(name = "Y series", values = c("ret" = "blue", "lret" = "red"))
  
```

As, we can see from the summary statistics, taking the log return seems to 
exaggerate the key statistics (mean, variance, skew, etc.) associated with the 
returns. This can be highlighted clearly on the plot which compares the normal
returns with the log returns for "MSFT". 

Clearly, we can see that there is a significant difference between the ordinary
returns and the log returns over time. This points towards the returns being 
non-negligible, with relatively high percentage changes. Ordinary returns and log
returns are only equal when they are **zero**, and they are approximately equal 
when they remain small. Therefore, the difference between the ordinary and the log
returns highlights that these returns are non-negligible - and that there is 
significant percentage change (which points towards relatively high volatility) 
for "MSFT".




# Q4
Yuting: I manually separate two worksheet into two excel files.

```{r}
daily_data <- read_excel("PS1_Daily_HPR_daily.xlsx") %>%
  janitor::clean_names()%>% 
  mutate(date = ymd(date))%>% pivot_longer(!date,names_to = "ticker",values_to = "ret")
skimr::skim(daily_data)
```

```{r, Question 5}
question5 <- c('msft', 'ge',"sprtrn")

daily_q5 <- daily_data %>%
  filter(ticker %in% question5) %>%
  group_by(ticker) %>% 
  arrange(ticker,date) %>% 
  mutate(ret1 = ret+1) %>% 
  mutate(inv_ret = cumprod(ret1)) %>% 
  select(-ret1)

daily_q5 %>% 
  ggplot(aes(x = date, y=inv_ret, group=ticker, color=ticker)) +
  geom_line()+
  theme_minimal()+
  labs(
    title="Daily Investment",
    y="Investment return",
    x="Date"
  )

```


```{r q6}
daily_log <-daily_data %>% 
  filter(ret > 0) %>% mutate(lret = log(ret))

sum_table_daily <-  daily_log %>% 
  group_by(ticker) %>% 
  summarise(ret_mean = mean(ret),
            logret_mean = mean(lret, na.rm = TRUE),
            ret_var = var(ret),
            logret_var = var(lret, na.rm = TRUE),
            ret_skew = skewness(ret),
            logret_skew = skewness(lret, na.rm = TRUE),
            ret_kur = kurtosis(ret),
            logret_kur = kurtosis(lret, na.rm = TRUE))
sum_table_daily
```

## Question 7

```{r q7-1}
#MSFT
#Monthly log returns
monthly_log %>%
  filter(ticker == "MSFT") %>%
  select(lret) %>%
  ggplot(aes(x = lret)) +
  geom_histogram(binwidth = 0.01) +
  stat_function(fun = dnorm,
                args = list(mean = mean(monthly_log$lret),
                            sd = sd(monthly_log$lret)),
                col = "#1b98e0",
                size = 1) +
  theme_bw() +
  labs(
    title = "Microsoft - Histogram of Log Monthly Returns",
    x = "Log Monthly Returns",
    y = "Density"
  )

#Daily log returns
daily_log %>%
  filter(ticker == "msft") %>%
  ggplot(aes(x = lret)) +
  geom_histogram(binwidth = 0.01) +
  stat_function(fun = dnorm,
                args = list(mean = mean(daily_log$lret),
                            sd = sd(daily_log$lret)),
                col = "#1b98e0",
                size = 1) +
  theme_bw() +
  labs(
    title = "Microsoft -  Histogram of Log Daily Returns",
    x = "Log Daily Returns",
    y = "Density"
  )

# While both graphs are leptokurtic (more values centered around the mean; higher bell)
# daily log returns by far have the highest kurtosis
```


```{r q7-2}
#General Electric
monthly_log %>%
  filter(ticker == "GE") %>%
  select(lret) %>%
  ggplot(aes(x = lret)) +
  geom_histogram(binwidth = 0.01) +
  stat_function(fun = dnorm,
                args = list(mean = mean(monthly_log$lret),
                            sd = sd(monthly_log$lret)),
                col = "#1b98e0",
                size = 1) +
  theme_bw() +
  labs(
    title = "General Electric - Histogram of Log Monthly Returns",
    x = "Log Monthly Returns",
    y = "Density"
  )

#Daily log returns
daily_log %>%
  filter(ticker == "ge") %>%
  ggplot(aes(x = lret)) +
  geom_histogram(binwidth = 0.01) +
  stat_function(fun = dnorm,
                args = list(mean = mean(daily_log$lret),
                            sd = sd(daily_log$lret)),
                col = "#1b98e0",
                size = 1) +
  theme_bw() +
  labs(
    title = "General Electric - Histogram of Log Daily Returns",
    x = "Log Daily Returns",
    y = "Density"
  )
```

# Question 8

Hovik: use MSFT, GE and JPM

```{r}
daily_q8_ret <- daily_data %>%
  select(-c(xom,intc,c,vwretd))  %>%
  pivot_longer(!date,names_to = "ticker",values_to = "ret")%>% 
  filter(ret > 0) %>% 
  mutate(lret = log(ret))

daily_q8_inv <-  daily_data %>%
         select(-c(xom,intc,c,vwretd))  %>%
         mutate(msft1 = msft +1,
         inv_msft = msft1 * lag(msft1),
         ge1 = ge +1,
         inv_ge = ge1 * lag(ge1),
         sprtrn1 = sprtrn +1,
         inv_sprtrn = sprtrn1 * lag(sprtrn1),
         jpm1 = jpm +1,
         inv_jpm = jpm1 * lag(jpm1),) %>% 
  mutate(inv_msft = if_else(is.na(inv_msft),1,inv_msft),
         inv_ge = if_else(is.na(inv_ge),1,inv_ge),
         inv_jpm = if_else(is.na(inv_jpm),1,inv_jpm),
         inv_sprtrn = if_else(is.na(inv_sprtrn),1,inv_sprtrn)) %>% 
  select(-msft1,-ge1,-sprtrn1,-jpm1,-msft,-ge,-sprtrn,-jpm) %>%
  mutate(msft = inv_msft, ge = inv_ge, sprtrn = inv_sprtrn, jpm = inv_jpm) %>%
  select(-inv_msft,-inv_ge,-inv_sprtrn,-inv_jpm) %>%
  pivot_longer(!date,names_to = "ticker",values_to = "inv")
  
daily_q8 <- left_join(daily_q8_ret, daily_q8_inv)
daily_q8
```

# Question 9



